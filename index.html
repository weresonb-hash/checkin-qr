<!DOCTYPE html>
<html lang="pt-BR" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Check-in System PRO - ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="html5-qrcode.min.js"></script>
    <script src="qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* Estilos personalizados */
        .view {
            transition: opacity 0.3s ease-in-out;
        }
        .hidden {
            display: none !important;
        }
        /* Estilo para mﾃｺltiplos selects */
        .select-multiple-height {
            height: 150px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="messageOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div id="messageBox" class="p-6 rounded-lg shadow-xl w-full max-w-sm transition duration-300 ease-in-out transform scale-100">
            <h3 id="messageTitle" class="text-xl font-bold mb-3 text-center"></h3>
            <p id="messageDetail" class="text-md mb-4 text-center"></p>
            <button onclick="closeMessageBox()" class="w-full p-2 rounded font-semibold transition duration-150 ease-in-out">Fechar</button>
        </div>
    </div>


    <div class="container mx-auto p-4">

        <div class="view hidden p-4 max-w-lg mx-auto bg-white shadow-lg rounded-xl mt-10" id="login-view">
            <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Sistema de Check-in Gym</h2>
            <div id="login-form-container" class="mt-4 p-6 border rounded-lg bg-gray-50">
                <h3 class="text-xl font-bold mb-3 text-gray-800">Acesso Administrativo</h3>
                <input type="password" id="adminPassword" placeholder="Senha do Administrador" class="w-full p-2 border rounded mb-4" onkeypress="if(event.keyCode == 13) handleAdminLogin()">
                <button id="adminLoginBtn" class="bg-indigo-600 text-white p-3 rounded w-full hover:bg-indigo-700 font-semibold">Entrar</button>
            </div>
        </div>

        <div class="view hidden" id="admin-view">
            <h1 class="text-4xl font-extrabold text-indigo-800 mb-6">Painel Administrativo</h1>
            
            <div class="flex flex-wrap gap-2 mb-6 p-4 bg-white rounded-lg shadow">
                <button id="btn-admin-quick-checkin" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Check-in Rﾃ｡pido</button>
                <button id="btn-admin-manage" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Gerenciar Alunos</button>
                <button id="btn-admin-manage-schedule" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Gerenciar Grade</button>
                <button id="btn-admin-checkin-history" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Histﾃｳrico de Check-in</button>
                <button id="btn-admin-logout" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 ml-auto">Sair (Logout)</button>
            </div>

            <div id="admin-sub-views">
                
                <div class="sub-view hidden p-6 bg-white rounded-lg shadow" id="admin-quick-checkin-view">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-700">Check-in Rﾃ｡pido Admin (Automﾃ｡tico)</h2>
                    
                    <div class="p-4 border border-blue-300 rounded-lg bg-blue-50 mb-4" id="available-classes-container">
                        <h4 class="font-semibold mb-3 text-blue-800">Aulas Abertas Agora (Janela de Check-in)</h4>
                        <div id="available-classes-list" class="divide-y divide-blue-200">
                            <p class="text-gray-500 italic">Carregando aulas...</p>
                        </div>
                    </div>
                    <div class="p-4 border rounded-lg bg-gray-50 mb-4">
                        <h4 class="font-semibold mb-3">1. Identificar Aluno e Fazer Check-in Automﾃ｡tico</h4>
                        <input type="text" id="quickCheckinStudentId" placeholder="ID do Aluno (Manual)" class="w-full p-2 border rounded mb-3" onkeypress="if(event.keyCode == 13) document.getElementById('btn-process-checkin').click()">
                        <div class="flex gap-2">
                             <button id="btn-open-admin-scanner" class="bg-blue-600 text-white p-3 rounded w-1/2 hover:bg-blue-700 font-semibold">Escanear QR do Aluno</button>
                             <button id="btn-process-checkin" class="bg-indigo-600 text-white p-3 rounded w-1/2 hover:bg-indigo-700 font-semibold">Check-in Automﾃ｡tico</button>
                        </div>
                    </div>
                </div>

                <div class="sub-view hidden p-6 bg-white rounded-lg shadow" id="admin-manage-students-view">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-700">Gerenciar Alunos</h2>
                    <button id="btn-add-new-student-admin" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 mb-4">Cadastrar Novo Aluno</button>
                    <div class="relative w-full sm:w-80">
                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" 
                             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        
                        <input type="text" id="searchStudentAdmin" 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" 
                               placeholder="Pesquisar aluno por nome ou ID..."
                               oninput="filterStudentsAdmin()">
                    </div>
                    <div id="edit-student-form-container" class="hidden p-4 mb-6 border border-indigo-300 rounded-lg bg-indigo-50">
                        <h3 id="edit-form-title" class="text-xl font-bold mb-3 text-indigo-800">Cadastrar Novo Aluno</h3>
                        <input type="hidden" id="edit-id-holder">
                        <input type="text" id="edit-name" placeholder="Nome Completo" class="w-full p-2 border rounded mb-2">
                        <input type="text" id="edit-phone" placeholder="Telefone" class="w-full p-2 border rounded mb-2">
                        <input type="date" id="edit-expiry-date" class="w-full p-2 border rounded mb-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Aulas Matriculadas (Multi-seleﾃｧﾃ｣o):</label>
                        <select id="edit-enrollment" multiple class="w-full p-2 border rounded mb-4 select-multiple-height">
                            </select>
                        <div class="flex space-x-2">
                            <button id="btn-save-student" class="flex-1 p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Salvar Aluno</button>
                            <button id="btn-cancel-edit" class="flex-1 p-2 bg-gray-500 text-white rounded hover:bg-gray-600">Cancelar</button>
                        </div>
                    

                    </div>
                    
                    <div id="student-list-table">
                        </div>
                </div>
                
                <div class="sub-view hidden p-6 bg-white rounded-lg shadow" id="admin-manage-schedule-view">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-700">Gerenciar Grade de Horﾃ｡rios</h2>
                    <button id="btn-add-new-class-admin" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 mb-4">Adicionar Nova Aula</button>
                    
                    <div id="edit-class-form-container" class="hidden p-4 mb-6 border border-purple-300 rounded-lg bg-purple-50">
                        <h3 id="edit-class-form-title" class="text-xl font-bold mb-3 text-purple-800">Cadastrar Nova Aula</h3>
                        <input type="hidden" id="edit-class-id-holder">
                        <input type="text" id="edit-class-modalidade" placeholder="Modalidade (Ex: Nataﾃｧﾃ｣o Adulto)" class="w-full p-2 border rounded mb-2">
                        
                        <div class="flex gap-2 mb-2">
                             <select id="edit-class-dia" class="w-1/2 p-2 border rounded">
                                <option value="">Selecione o Dia</option>
                                <option value="Segunda">Segunda</option>
                                <option value="Terﾃｧa">Terﾃｧa</option>
                                <option value="Quarta">Quarta</option>
                                <option value="Quinta">Quinta</option>
                                <option value="Sexta">Sexta</option>
                                <option value="Sﾃ｡bado">Sﾃ｡bado</option>
                                <option value="Domingo">Domingo</option>
                             </select>
                             <input type="text" id="edit-class-horario" placeholder="Horﾃ｡rio (Ex: 08:30 ou 06:00 - 22:00)" class="w-1/2 p-2 border rounded">
                        </div>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="edit-class-professor" placeholder="Professor" class="w-1/3 p-2 border rounded">
                            <input type="number" id="edit-class-capacidade" placeholder="Capacidade" value="1" min="1" class="w-1/3 p-2 border rounded">
                            <input type="text" id="edit-class-token" placeholder="Token (Ex: LOR0830 ou MUSC)" class="w-1/3 p-2 border rounded uppercase">
                        </div>

                        <div class="flex space-x-2">
                            <button id="btn-save-class" class="flex-1 p-2 bg-purple-600 text-white rounded hover:bg-purple-700">Salvar Aula</button>
                            <button id="btn-cancel-class-edit" class="flex-1 p-2 bg-gray-500 text-white rounded hover:bg-gray-600">Cancelar</button>
                        </div>
                    </div>

                    <div id="schedule-list-container">
                        </div>
                </div>

                <div class="sub-view hidden p-6 bg-white rounded-lg shadow" id="admin-history-view">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-700">Histﾃｳrico de Check-in</h2>
                    
                    <div class="p-4 mb-4 border rounded-lg bg-gray-50">
                        <h4 class="font-semibold mb-3">Filtros (<span id="countDisplay" class="font-bold text-indigo-600">0</span> registros)</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-end">
                            
                            <div>
                                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-0.5">Data Inﾃｭcio</label>
                                <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
                            </div>
                            
                            <div>
                                <label for="endDate" class="block text-sm font-medium text-gray-700 mb-0.5">Data Final</label>
                                <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
                            </div>
                            
                            <div>
                                <label for="modalidadeFilter" class="block text-sm font-medium text-gray-700 mb-0.5">Modalidade</label>
                                <select id="modalidadeFilter" class="w-full p-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
                                    <option value="">Todas</option>
                                    </select>
                            </div>
                            
                            <div>
                                <label for="professorFilter" class="block text-sm font-medium text-gray-700 mb-0.5">Professor</label>
                                <select id="professorFilter" class="w-full p-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
                                    <option value="">Todos</option>
                                    </select>
                            </div>
                            
                            <div>
                                <label for="horarioFilter" class="block text-sm font-medium text-gray-700 mb-0.5">Horﾃ｡rio</label>
                                <select id="horarioFilter" class="w-full p-2 border border-gray-300 rounded-lg" onchange="applyFilters()">
                                    <option value="">Todos</option>
                                    </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-0.5 invisible">Aﾃｧﾃｵes</label> 
                                <div class="flex space-x-2">
                                    <button id="applyFiltersBtn" class="flex-1 p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700" onclick="applyFilters()">Aplicar</button>
                                    <button id="clearAllFiltersBtn" onclick="clearAllFilters()" class="flex-1 p-2 bg-gray-500 text-white rounded hover:bg-gray-600">Limpar</button>
                                </div>
                            </div>
                
                            <div class="relative col-span-1">
                                <label for="searchStudentHistory" class="block text-sm font-medium text-gray-700 mb-0.5">Pesquisar Aluno/ID</label>
                                <svg class="absolute left-3 top-[2.1rem] transform -translate-y-1/2 h-5 w-5 text-gray-400" 
                                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                <input type="text" id="searchStudentHistory" 
                                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" 
                                       placeholder="Nome ou ID"
                                       oninput="renderCheckinHistory()">
                            </div>
                            
                        </div> </div> <div id="loadingIndicator" class="text-center p-4 text-indigo-600 hidden">Carregando histﾃｳrico...</div>
                    <div id="historyContent" class="mt-4">
                        </div>
                </div>

            </div>
        </div>
        
    </div>

    <div id="qrCodeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <h4 class="text-xl font-bold mb-4 text-indigo-700">QR Code de Acesso</h4>
            <div id="qrcodeDisplay" class="flex justify-center mb-4"></div>
            <p class="text-sm text-gray-600">Use este cﾃｳdigo para identificar o aluno.</p>
            <button id="closeQrCodeModalBtn" onclick="closeQrCodeModal()" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Fechar</button>
        </div>
    </div>

    <div id="adminScannerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center w-full max-w-lg">
            <h4 class="text-xl font-bold mb-4 text-indigo-700">Escanear QR Code</h4>
            <div id="admin-qr-reader" class="w-full flex justify-center mb-4"></div>
            <p id="admin-qr-status" class="text-sm text-red-500 mb-4"></p>
            <button id="closeAdminScannerBtn" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Cancelar</button>
        </div>
    </div>

    <div id="gradeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 text-indigo-700">Grade de Horﾃ｡rios Completa</h3>
            <div id="gradeContent" class="divide-y divide-gray-100">
                </div>
            <button id="closeGradeModalBtn" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Fechar</button>
        </div>
    </div>


    <script>
        // --- CRITﾃ嘘IOS DE VALIDAﾃﾃグ (EDITﾃ〃EIS) ---
        const JANELA_ANTES_MINUTOS = 15;
        const JANELA_DEPOIS_MINUTOS = 30;
        const ADMIN_PASSWORD = 'admin123'; // 泊 Senha de acesso admin

        // --- Constantes IndexedDB ---
        const DB_NAME = 'GymCheckinDB';
        const DB_VERSION = 11; 
        const STORE_CHECKINS = 'checkins';
        const STORE_PROFILES = 'profiles';
        const STORE_SCHEDULE = 'schedule';

        let dbInstance = null;
        let qrCodeScannerAdmin = null;
        let currentProfile = null; 
        let allCheckins = [];
        let ALL_CLASS_OPTIONS = [];
        let allProfiles = [];
        let GRADE_SCHEDULE_RUNTIME = {};
        let classRefreshInterval = null; // NOVO: Variﾃ｡vel para o timer de atualizaﾃｧﾃ｣o de aulas
        let FIREBASE_DB = null;

        // --- Dados da Grade e Utilitﾃ｡rios de Tempo ---
        const DAYS_OF_WEEK_PT = ['Domingo', 'Segunda', 'Terﾃｧa', 'Quarta', 'Quinta', 'Sexta', 'Sﾃ｡bado'];
        const DAY_ORDER_MAP = {
            'Domingo': 7, 
            'Segunda': 1,
            'Terﾃｧa': 2,
            'Quarta': 3,
            'Quinta': 4,
            'Sexta': 5,
            'Sﾃ｡bado': 6
        };

        // Dados da grade hardcoded original (APENAS PARA MIGRAﾃﾃグ INICIAL)
        const HARDCODED_GRADE_SCHEDULE = {
            "Hidroginﾃ｡stica": {
                "Segunda": [{"horario": "07:00", "professor": "Lorena", "capacidade": 30, "id": "HIDRO-SEG-0700-LOR", "token": "LOR0700"}, {"horario": "08:20", "professor": "Lorena", "capacidade": 30, "id": "HIDRO-SEG-0820-LOR", "token": "LOR0820"}, {"horario": "17:10", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-SEG-1710-VAN", "token": "VAN1710"}, {"horario": "19:10", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-SEG-1910-VAN", "token": "VAN1910"}],
                "Terﾃｧa": [{"horario": "07:40", "professor": "Lorena", "capacidade": 30, "id": "HIDRO-TER-0740-LOR", "token": "LOR0740"}, {"horario": "08:20", "professor": "Lorena", "capacidade": 30, "id": "HIDRO-TER-0820-LOR", "token": "LOR0820"}, {"horario": "15:40", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-TER-1540-VAN", "token": "VAN1540"}, {"horario": "16:20", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-TER-1620-VAN", "token": "VAN1620"}, {"horario": "18:30", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-TER-1830-VAN", "token": "VAN1830"}],
                "Quarta": [{"horario": "07:00", "professor": "Lorena", "capacidade": 30, "id": "HIDRO-QUA-0700-LOR", "token": "LOR0700"}, {"horario": "08:20", "professor": "Lorena", "capacidade": 30, "id": "HIDRO-QUA-0820-LOR", "token": "LOR0820"}, {"horario": "17:10", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-QUA-1710-VAN", "token": "VAN1710"}, {"horario": "19:10", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-QUA-1910-VAN", "token": "VAN1910"}],
                "Quinta": [{"horario": "07:40", "professor": "Lorena", "capacidade": 30, "id": "HIDRO-QUI-0740-LOR", "token": "LOR0740"}, {"horario": "08:20", "professor": "Lorena", "capacidade": 30, "id": "HIDRO-QUI-0820-LOR", "token": "LOR0820"}, {"horario": "15:40", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-QUI-1540-VAN", "token": "VAN1540"}, {"horario": "16:20", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-QUI-1620-VAN", "token": "VAN1620"}, {"horario": "18:30", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-QUI-1830-VAN", "token": "VAN1830"}],
                "Sexta": [{"horario": "07:00", "professor": "Lorena", "capacidade": 30, "id": "HIDRO-SEX-0700-LOR", "token": "LOR0700"}, {"horario": "08:20", "professor": "Lorena", "capacidade": 30, "id": "HIDRO-SEX-0820-LOR", "token": "LOR0820"}, {"horario": "17:10", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-SEX-1710-VAN", "token": "VAN1710"}, {"horario": "19:10", "professor": "Vanessa", "capacidade": 30, "id": "HIDRO-SEX-1910-VAN", "token": "VAN1910"}]
            },
            "Nataﾃｧﾃ｣o 1 a 3 anos": {
                "Segunda": [{"horario": "15:50", "professor": "Vanessa", "capacidade": 6, "id": "NATA1-SEG-1550-VAN", "token": "NATA1VAN1550"}],
                "Terﾃｧa": [{"horario": "09:40", "professor": "Lorena", "capacidade": 6, "id": "NATA1-TER-0940-LOR", "token": "NATA1LOR0940"}],
                "Quarta": [{"horario": "15:50", "professor": "Vanessa", "capacidade": 6, "id": "NATA1-QUA-1550-VAN", "token": "NATA1VAN1550"}],
                "Quinta": [{"horario": "09:40", "professor": "Lorena", "capacidade": 6, "id": "NATA1-QUI-0940-LOR", "token": "NATA1LOR0940"}],
                "Sexta": [{"horario": "15:50", "professor": "Vanessa", "capacidade": 6, "id": "NATA1-SEX-1550-VAN", "token": "NATA1VAN1550"}]
            },
            "Nataﾃｧﾃ｣o 2 a 4 anos": {
                "Terﾃｧa": [{"horario": "17:30", "professor": "Vanessa", "capacidade": 6, "id": "NATA2-TER-1730-VAN", "token": "NATA2VAN1730"}],
                "Quinta": [{"horario": "17:30", "professor": "Vanessa", "capacidade": 6, "id": "NATA2-QUI-1730-VAN", "token": "NATA2VAN1730"}]
            },
            "Nataﾃｧﾃ｣o 4 a 6 anos": {
                "Segunda": [{"horario": "09:40", "professor": "Lorena", "capacidade": 6, "id": "NATA4-SEG-0940-LOR", "token": "NATA4LOR0940"}, {"horario": "14:40", "professor": "Vanessa", "capacidade": 6, "id": "NATA4-SEG-1440-VAN", "token": "NATA4VAN1440"}],
                "Terﾃｧa": [{"horario": "14:30", "professor": "Vanessa", "capacidade": 6, "id": "NATA4-TER-1430-VAN", "token": "NATA4VAN1430"}, {"horario": "17:00", "professor": "Vanessa", "capacidade": 6, "id": "NATA4-TER-1700-VAN", "token": "NATA4VAN1700"}, {"horario": "18:00", "professor": "Vanessa", "capacidade": 6, "id": "NATA4-TER-1800-VAN", "token": "NATA4VAN1800"}],
                "Quarta": [{"horario": "09:40", "professor": "Lorena", "capacidade": 6, "id": "NATA4-QUA-0940-LOR", "token": "NATA4LOR0940"}, {"horario": "14:40", "professor": "Vanessa", "capacidade": 6, "id": "NATA4-QUA-1440-VAN", "token": "NATA4VAN1440"}],
                "Quinta": [{"horario": "14:30", "professor": "Vanessa", "capacidade": 6, "id": "NATA4-QUI-1430-VAN", "token": "NATA4VAN1430"}, {"horario": "17:00", "professor": "Vanessa", "capacidade": 6, "id": "NATA4-QUI-1700-VAN", "token": "NATA4VAN1700"}, {"horario": "18:00", "professor": "Vanessa", "capacidade": 6, "id": "NATA4-QUI-1800-VAN", "token": "NATA4VAN1800"}],
                "Sexta": [{"horario": "09:40", "professor": "Lorena", "capacidade": 6, "id": "NATA4-SEX-0940-LOR", "token": "NATA4LOR0940"}, {"horario": "14:40", "professor": "Vanessa", "capacidade": 6, "id": "NATA4-SEX-1440-VAN", "token": "NATA4VAN1440"}]
            },
            "Nataﾃｧﾃ｣o 6 a 10 anos": {
                "Segunda": [{"horario": "09:00", "professor": "Lorena", "capacidade": 8, "id": "NATA6-SEG-0900-LOR", "token": "NATA6LOR0900"}],
                "Terﾃｧa": [{"horario": "09:00", "professor": "Lorena", "capacidade": 8, "id": "NATA6-TER-0900-LOR", "token": "NATA6LOR0900"}],
                "Quarta": [{"horario": "09:00", "professor": "Lorena", "capacidade": 8, "id": "NATA6-QUA-0900-LOR", "token": "NATA6LOR0900"}],
                "Quinta": [{"horario": "09:00", "professor": "Lorena", "capacidade": 8, "id": "NATA6-QUI-0900-LOR", "token": "NATA6LOR0900"}],
                "Sexta": [{"horario": "09:00", "professor": "Lorena", "capacidade": 8, "id": "NATA6-SEX-0900-LOR", "token": "NATA6LOR0900"}]
            },
            "Nataﾃｧﾃ｣o Adulto": {
                "Terﾃｧa": [{"horario": "06:00", "professor": "Lorena", "capacidade": 10, "id": "NATAAD-TER-0600-LOR", "token": "NATAADLOR0600"}, {"horario": "19:40", "professor": "Vanessa", "capacidade": 10, "id": "NATAAD-TER-1940-VAN", "token": "NATAADVAN1940"}],
                "Quinta": [{"horario": "06:00", "professor": "Lorena", "capacidade": 10, "id": "NATAAD-QUI-0600-LOR", "token": "NATAADLOR0600"}, {"horario": "19:40", "professor": "Vanessa", "capacidade": 10, "id": "NATAAD-QUI-1940-VAN", "token": "NATAADVAN1940"}]
            },
            "Musculaﾃｧﾃ｣o": {
                "Segunda": [{"horario": "06:00 - 22:00", "professor": "Vﾃ｡rios", "capacidade": 100, "id": "MUSC-SEG", "token": "MUSC"}],
                "Terﾃｧa": [{"horario": "06:00 - 22:00", "professor": "Vﾃ｡rios", "capacidade": 100, "id": "MUSC-TER", "token": "MUSC"}],
                "Quarta": [{"horario": "06:00 - 22:00", "professor": "Vﾃ｡rios", "capacidade": 100, "id": "MUSC-QUA", "token": "MUSC"}],
                "Quinta": [{"horario": "06:00 - 22:00", "professor": "Vﾃ｡rios", "capacidade": 100, "id": "MUSC-QUI", "token": "MUSC"}],
                "Sexta": [{"horario": "06:00 - 21:00", "professor": "Vﾃ｡rios", "capacidade": 100, "id": "MUSC-SEX", "token": "MUSC"}],
                "Sﾃ｡bado": [{"horario": "08:00 - 12:00", "professor": "Vﾃ｡rios", "capacidade": 50, "id": "MUSC-SAB", "token": "MUSC"}]
            }
        };

        const QR_SCANNER_CONFIG = {
            fps: 25,
            qrbox: { width: 200, height: 200 }, 
            videoConstraints: {
                facingMode: { ideal: "environment" }, 
                width: {ideal: 1920 },
                height: {ideal: 1080 }
                
            }
        };


        const firebaseConfig = {
            apiKey: "AIzaSyCJJ0oMna9mMH948OPZm_Fa-VcLzeSb_9Q",
            authDomain: "gym-checkin-pro.firebaseapp.com",
            projectId: "gym-checkin-pro",
            storageBucket: "gym-checkin-pro.firebasestorage.app",
            messagingSenderId: "1067829447294",
            appId: "1:1067829447294:web:6aec373b92ea91bc13662f",
            measurementId: "G-T9TR5Q471L"
        };


        // Funﾃｧﾃ｣o para Inicializar o Firebase e o Firestore
        function initFirebase() {
            try {
                // Se jﾃ｡ estiver inicializado, nﾃ｣o faﾃｧa nada
                if (firebase.apps.length > 0) {
                    console.log("Firebase jﾃ｡ inicializado.");
                    return;
                }
                
                const app = firebase.initializeApp(firebaseConfig);
                FIREBASE_DB = firebase.firestore();
                console.log("Firebase e Firestore inicializados com sucesso!");
                
            } catch (e) {
                console.error("Erro ao inicializar Firebase:", e);
                showMessageBox('Erro Crﾃｭtico', 'Falha ao conectar ao banco de dados na nuvem.', 'error');
            }
        }

        // --- Funﾃｧﾃｵes de Utilitﾃ｡rios de Tempo e Formataﾃｧﾃ｣o (SEM ALTERAﾃﾃグ) ---

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const options = {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: false
            };
            return new Intl.DateTimeFormat('pt-BR', options).format(date);
        }

        function formatDate(dateIn) {
            const date = typeof dateIn === 'string' ? new Date(dateIn.replace(/-/g, '/')) : dateIn;
            if (isNaN(date)) return 'N/A';
            return date.toLocaleDateString('pt-BR');
        }

        function getUniqueUserId() {
            return 'A' + Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function getExpirationStatus(expiryDateStr) {
            const today = new Date();
            const expiryDate = new Date(expiryDateStr);
            expiryDate.setHours(23, 59, 59, 999);

            const expired = today > expiryDate;
            const display = formatDate(expiryDate);

            return { expired, display };
        }

        // --- IndexedDB Management (SEM ALTERAﾃﾃグ) ---

        function openDB() {
             return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_PROFILES)) {
                        db.createObjectStore(STORE_PROFILES, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(STORE_CHECKINS)) {
                        const checkinStore = db.createObjectStore(STORE_CHECKINS, { keyPath: 'timestamp' });
                        checkinStore.createIndex('by_token', 'token', { unique: false });
                        checkinStore.createIndex('by_modalidade', 'modalidade', { unique: false });
                        checkinStore.createIndex('by_professor', 'professor', { unique: false });
                        checkinStore.createIndex('by_userId', 'userId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORE_SCHEDULE)) {
                        const scheduleStore = db.createObjectStore(STORE_SCHEDULE, { keyPath: 'id' });
                        scheduleStore.createIndex('by_modalidade', 'modalidade', { unique: false });
                        scheduleStore.createIndex('by_professor', 'professor', { unique: false });
                        scheduleStore.createIndex('by_horario', 'horario', { unique: false });
                        scheduleStore.createIndex('by_token', 'token', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    dbInstance = event.target.result;
                    resolve(dbInstance);
                };

                request.onerror = (e) => {
                    console.error('Erro ao abrir IndexedDB:', e);
                    showMessageBox('Erro Crﾃｭtico', 'Nﾃ｣o foi possﾃｭvel inicializar o banco de dados local.', 'error');
                    reject(e);
                };
            });
        }

        function flattenGradeSchedule(grade) {
            const flattened = [];
            for (const modalidade in grade) {
                for (const dia in grade[modalidade]) {
                    grade[modalidade][dia].forEach(aula => {
                        flattened.push({
                            ...aula,
                            modalidade: modalidade,
                            dia: dia
                        });
                    });
                }
            }
            return flattened;
        }

        async function getAllClassInstances() {
             if (!dbInstance) await openDB();
            return new Promise((resolve, reject) => {
                const transaction = dbInstance.transaction([STORE_SCHEDULE], 'readonly');
                const store = transaction.objectStore(STORE_SCHEDULE);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (e) => {
                    console.error('Erro ao buscar instﾃ｢ncias de aula:', e);
                    reject(e);
                };
            });
        }

        async function loadScheduleFromDB() {
            try {
                // Tenta buscar do Firestore
                let allInstances = await getAllClassInstances(); 
                
                // Se o Firestore estiver vazio, executa a migraﾃｧﾃ｣o dos dados fixos
                if (allInstances.length === 0) {
                    allInstances = await migrateHardcodedSchedule();
                }
                
                // O restante da lﾃｳgica permanece igual (popula as variﾃ｡veis globais ALL_CLASS_OPTIONS e GRADE_SCHEDULE_RUNTIME)
                ALL_CLASS_OPTIONS = allInstances;
                
                GRADE_SCHEDULE_RUNTIME = {};
                ALL_CLASS_OPTIONS.forEach(aula => {
                    const modalidade = aula.modalidade;
                    const dia = aula.dia;
                    
                    if (!GRADE_SCHEDULE_RUNTIME[modalidade]) {
                        GRADE_SCHEDULE_RUNTIME[modalidade] = {};
                    }
                    if (!GRADE_SCHEDULE_RUNTIME[modalidade][dia]) {
                        GRADE_SCHEDULE_RUNTIME[modalidade][dia] = [];
                    }
                    GRADE_SCHEDULE_RUNTIME[modalidade][dia].push(aula);
                });

                console.log(`Grade de horﾃ｡rios carregada. Total de aulas: ${ALL_CLASS_OPTIONS.length}`);
                
            } catch (e) {
                console.error('Erro ao carregar Grade de Horﾃ｡rios (Firestore):', e);
                showMessageBox('Erro de Carga', 'Nﾃ｣o foi possﾃｭvel carregar a grade de horﾃ｡rios da nuvem.', 'error');
            }
        }

        async function migrateHardcodedSchedule() {
             if (!dbInstance) await openDB();
            const flattened = flattenGradeSchedule(HARDCODED_GRADE_SCHEDULE);
            const transaction = dbInstance.transaction([STORE_SCHEDULE], 'readwrite');
            const store = transaction.objectStore(STORE_SCHEDULE);
            for (const aula of flattened) {
                store.put(aula);
            }
            return new Promise((resolve, reject) => {
                transaction.oncomplete = () => {
                    console.log("Migraﾃｧﾃ｣o da grade concluﾃｭda.");
                    resolve();
                };
                transaction.onerror = (e) => {
                    console.error("Erro na transaﾃｧﾃ｣o de migraﾃｧﾃ｣o:", e);
                    reject(e);
                };
            });
        }

        // --- Funﾃｧﾃｵes de Perfil (CRUD) (SEM ALTERAﾃﾃグ) ---

        async function saveProfileToDB(profile) {
            if (!FIREBASE_DB) throw new Error("Firestore nﾃ｣o estﾃ｡ inicializado.");
            
            // Usa o ID do perfil (token QR Code ou ID) como ID do Documento
            const profileRef = FIREBASE_DB.collection(STORE_PROFILES).doc(profile.id);

            try {
                // O mﾃｩtodo set com { merge: true } garante a atualizaﾃｧﾃ｣o (se existir) ou criaﾃｧﾃ｣o (se for novo).
                await profileRef.set(profile, { merge: true });
                
                console.log(`Perfil ${profile.name} salvo/atualizado no Firestore.`);
                return true;
            } catch (e) {
                console.error("Erro ao salvar perfil no Firestore:", e);
                showMessageBox('Erro', `Falha ao salvar perfil de ${profile.name} na nuvem.`, 'error');
                return false;
            }
        }

                // VERSﾃグ FIRESTORE:
        async function getProfile(id) {
            if (!FIREBASE_DB) {
                // Fallback para IndexedDB se o Firebase nﾃ｣o estiver ativo (APENAS PARA GARANTIA)
                return getProfileLocal(id); 
            }
            
            try {
                const docRef = FIREBASE_DB.collection(STORE_PROFILES).doc(id);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    let profile = docSnap.data();
                    
                    // Mantenha as correﾃｧﾃｵes crﾃｭticas para garantir arrays
                    if (!profile.enrollment) profile.enrollment = [];
                    if (!profile.history) profile.history = [];
                    
                    return profile;
                } else {
                    // Se nﾃ｣o encontrar na nuvem, retorna null
                    return null;
                }
            } catch (e) {
                console.error("Erro ao buscar perfil no Firestore:", e);
                // Em caso de erro, tenta buscar a versﾃ｣o local como fallback
                return getProfileLocal(id); 
            }
        }

        // NOVO: Funﾃｧﾃ｣o de Fallback (IndexedDB)
        async function getProfileLocal(id) {
            if (!dbInstance) await openDB();
            return new Promise((resolve) => {
                const transaction = dbInstance.transaction([STORE_PROFILES], 'readonly');
                const store = transaction.objectStore(STORE_PROFILES);
                const request = store.get(id);
                
                request.onsuccess = (event) => {
                    let profile = event.target.result;
                    if (profile) {
                        // Garante que enrollment e history existam (necessﾃ｡rio para o seu cﾃｳdigo)
                        if (!profile.enrollment) profile.enrollment = [];
                        if (!profile.history) profile.history = [];
                    }
                    resolve(profile);
                };
                request.onerror = () => resolve(null);
            });
        }


                // VERSﾃグ FIRESTORE:
        async function getAllProfiles() {
            if (!FIREBASE_DB) return []; // Retorna vazio se nﾃ｣o houver conexﾃ｣o
            
            try {
                const snapshot = await FIREBASE_DB.collection(STORE_PROFILES)
                    .orderBy('name') 
                    .get();
                    
                const profiles = [];
                snapshot.forEach(doc => {
                    profiles.push(doc.data());
                });
                
                // **IMPORTANTE:** Atualiza a variﾃ｡vel global usada na aplicaﾃｧﾃ｣o
                // A variﾃ｡vel 'allProfiles' que vocﾃｪ usou na versﾃ｣o IndexedDB
                window.ALL_STUDENTS_PROFILES = profiles; 
                
                console.log(`Perfis de alunos carregados do Firestore. Total: ${profiles.length}`);
                
                return profiles;
                
            } catch (e) {
                console.error("Erro ao carregar perfis do Firestore:", e);
                showMessageBox('Erro de Carga', 'Nﾃ｣o foi possﾃｭvel carregar os perfis de alunos da nuvem.', 'error');
                return [];
            }
        }


        // VERSﾃグ FIRESTORE:
        async function deleteProfile(id) {
            if (!FIREBASE_DB) throw new Error("Firestore nﾃ｣o estﾃ｡ inicializado.");
            
            try {
                // 1. Deleta do Firestore (a nuvem)
                await FIREBASE_DB.collection(STORE_PROFILES).doc(id).delete();
                
                // 2. Deleta do IndexedDB local (boa prﾃ｡tica para limpar o cache)
                await deleteProfileLocalCache(id);
                
                console.log(`Perfil ${id} deletado do Firestore e do cache local.`);
                return true;

            } catch (e) {
                console.error("Erro ao deletar perfil no Firestore:", e);
                showMessageBox('Erro', 'Falha ao deletar perfil na nuvem.', 'error');
                return false;
            }
        }

        // NOVO: Funﾃｧﾃ｣o de deleﾃｧﾃ｣o de cache (IndexedDB)
        async function deleteProfileLocalCache(id) {
            if (!dbInstance) await openDB();
            return new Promise((resolve, reject) => {
                const transaction = dbInstance.transaction([STORE_PROFILES], 'readwrite');
                const store = transaction.objectStore(STORE_PROFILES);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (e) => {
                    console.warn('Aviso: Falha ao deletar perfil do cache local (IndexedDB).', e);
                    resolve(); // Resolve mesmo com erro no cache, pois o principal (Firestore) foi excluﾃｭdo.
                };
            });
        }

        // --- Funﾃｧﾃｵes de MIGRAﾃﾃグ INICIAL (UMA ﾃ哢ICA VEZ) ---

                // NOVO: Funﾃｧﾃ｣o para migrar perfis locais para a nuvem
        async function migrateLocalProfilesToCloud() {
            console.log("Verificando se hﾃ｡ perfis locais para migrar...");
            
            // Usa a versﾃ｣o local da funﾃｧﾃ｣o para buscar todos os perfis do IndexedDB
            const localProfiles = await getAllProfilesLocal(); 
            
            if (localProfiles.length > 0) {
                console.log(`Encontrados ${localProfiles.length} perfis locais. Iniciando migraﾃｧﾃ｣o para o Firestore.`);
                
                let successCount = 0;
                for (const profile of localProfiles) {
                    try {
                        // Usa a nova funﾃｧﾃ｣o de salvamento do Firestore
                        await saveProfileToDB(profile); 
                        successCount++;
                    } catch (e) {
                        console.error(`Falha ao migrar perfil ${profile.id}:`, e);
                    }
                }
                
                if (successCount > 0) {
                    showMessageBox('Migraﾃｧﾃ｣o de Perfis', `${successCount} perfis de alunos migrados para o Cloud Firestore com sucesso!`, 'success');
                }
            }
            return localProfiles;
        }

        // NOVO: Versﾃ｣o IndexedDB para buscar todos (necessﾃ｡rio para a migraﾃｧﾃ｣o)
        async function getAllProfilesLocal() {
            if (!dbInstance) await openDB();
            return new Promise((resolve, reject) => {
                const transaction = dbInstance.transaction([STORE_PROFILES], 'readonly');
                const store = transaction.objectStore(STORE_PROFILES);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (e) => {
                    console.error('Erro ao buscar todos os perfis locais:', e);
                    reject(e);
                };
            });
        }



        // --- Funﾃｧﾃｵes de Agendamento (CRUD) (FIREBASE IMPLEMENTATION) ---

        async function saveClassInstance(classInstance) {
            if (!FIREBASE_DB) throw new Error("Firestore nﾃ｣o estﾃ｡ inicializado.");
            
            // Usa o token da aula como ID do documento para fﾃ｡cil referﾃｪncia
            const classRef = FIREBASE_DB.collection(STORE_SCHEDULE).doc(classInstance.id);
            
            // O mﾃｩtodo set com { merge: true } garante que o documento seja criado (se nﾃ｣o existir) ou atualizado.
            await classRef.set(classInstance, { merge: true });
        }

        // NOVO: Funﾃｧﾃ｣o para BUSCAR TODOS no Firestore
        // --------------------------------------------------------
        async function getAllClassInstances() {
            if (!FIREBASE_DB) return []; // Retorna vazio se nﾃ｣o houver conexﾃ｣o
            
            const snapshot = await FIREBASE_DB.collection(STORE_SCHEDULE)
                // Opcional: Para manter a ordem, podemos ordenar por modalidade e horﾃ｡rio
                .orderBy('modalidade') 
                .get();
                
            const classes = [];
            snapshot.forEach(doc => {
                classes.push(doc.data());
            });
            
            return classes;
        }

        // NOVO: Funﾃｧﾃ｣o para DELETAR no Firestore
        // --------------------------------------------------------
        async function deleteClass(id) {
            if (!FIREBASE_DB) throw new Error("Firestore nﾃ｣o estﾃ｡ inicializado.");
            
            // O id do documento ﾃｩ o id da aula
            await FIREBASE_DB.collection(STORE_SCHEDULE).doc(id).delete();
            
            // Chamada auxiliar para apagar do IndexedDB (apenas para limpar dados locais antigos)
            try {
                await deleteClassLocal(id); 
            } catch (e) {
                console.warn("Falha ao deletar do IndexedDB local (ignorado se o IndexedDB for descontinuado):", e);
            }
        }

        async function deleteClassLocal(id) {
            if (!dbInstance) await openDB();
            return new Promise((resolve, reject) => {
                const transaction = dbInstance.transaction([STORE_SCHEDULE], 'readwrite');
                const store = transaction.objectStore(STORE_SCHEDULE);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (e) => {
                    console.error('Erro ao deletar instﾃ｢ncia de aula do DB local:', e);
                    reject(e);
                };
            });
        }


        // --------------------------------------------------------
        // NOVO: Funﾃｧﾃ｣o para migrar dados fixos (chamada ﾃｺnica)
        // --------------------------------------------------------
        async function migrateHardcodedSchedule() {
            console.log("Iniciando migraﾃｧﾃ｣o da grade hardcoded para o Firestore...");

            // 1. A funﾃｧﾃ｣o flattenGradeSchedule transforma o objeto GRANDE em um ARRAY de objetos simples
            const flattenedSchedule = flattenGradeSchedule(HARDCODED_GRADE_SCHEDULE);

            let successCount = 0;
            // 2. Itera sobre a lista e salva cada item no Firestore
            for (const item of flattenedSchedule) {
                try {
                    await saveClassInstance(item); // Usa a nova funﾃｧﾃ｣o de salvamento do Firestore!
                    successCount++;
                } catch (e) {
                    console.error(`Falha ao salvar item ${item.id}:`, e);
                }
            }
            
            if (successCount > 0) {
                showMessageBox('Migraﾃｧﾃ｣o de Dados', `${successCount} aulas prﾃｩ-configuradas salvas no Cloud Firestore com sucesso!`, 'success');
            }

            // Retorna a lista completa de aulas salvas
            return flattenedSchedule;
        }


        // --- Funﾃｧﾃｵes de Check-in (CRUD) (SEM ALTERAﾃﾃグ) ---

        async function addCheckin(checkinData) {
            if (!FIREBASE_DB) {
                // Se o Firebase falhar, podemos manter a versﾃ｣o local como fallback de emergﾃｪncia.
                console.error("Firestore nﾃ｣o estﾃ｡ inicializado. Tentando salvar localmente.");
                return addCheckinLocal(checkinData); 
            }
            
            // O Firestore usa o ServerTimestamp para precisﾃ｣o de sincronizaﾃｧﾃ｣o.
            const dataToSave = { 
                ...checkinData, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                // Adiciona um novo documento ﾃ coleﾃｧﾃ｣o, deixando o Firestore gerar o ID
                await FIREBASE_DB.collection(STORE_CHECKINS).add(dataToSave);
                
                console.log(`Novo check-in salvo no Firestore para o token: ${checkinData.token}`);
                
            } catch (e) {
                console.error("Erro ao salvar check-in no Firestore:", e);
                showMessageBox('Erro', 'Falha ao registrar check-in na nuvem. Verifique as regras do Firestore.', 'error');
                // Em caso de falha na nuvem, podemos salvar localmente para nﾃ｣o perder o registro.
                return addCheckinLocal(checkinData); 
            }
        }

        async function getCheckins(filters = {}) {
            if (!FIREBASE_DB) return getCheckinsLocal(filters); // Fallback

            try {
                // 1. Consulta Inicial (Firestore)
                let query = FIREBASE_DB.collection(STORE_CHECKINS);
                
                // Sempre ordena por timestamp (descendente = mais recente primeiro)
                query = query.orderBy('timestamp', 'desc');

                const snapshot = await query.get();
                    
                let data = [];
                snapshot.forEach(doc => {
                    let record = doc.data();
                    
                    // 2. Converte o ServerTimestamp do Firestore para um timestamp JavaScript (nﾃｺmero)
                    if (record.timestamp && typeof record.timestamp.toDate === 'function') {
                        record.timestamp = record.timestamp.toDate().getTime(); 
                    }
                    
                    data.push(record);
                });
                
                // 3. Aplica todos os filtros complexos restantes no lado do cliente
                if (filters.userId) {
                    data = data.filter(c => c.userId === filters.userId);
                }
                
                // Filtros de Data
                if (filters.startDate) {
                    const dateString = filters.startDate;
                    const [year, month, day] = dateString.split('-').map(Number);
                    const startTS = new Date(year, month - 1, day, 0, 0, 0, 0).getTime();
                    data = data.filter(c => c.timestamp >= startTS);
                }
                if (filters.endDate) {
                    const dateString = filters.endDate;
                    const [year, month, day] = dateString.split('-').map(Number);
                    const endTS = new Date(year, month - 1, day, 23, 59, 59, 999).getTime();
                    data = data.filter(c => c.timestamp <= endTS);
                }
                
                // Filtros de Modalidade/Professor/Horﾃ｡rio
                if (filters.modalidade) {
                    data = data.filter(c => c.modalidade === filters.modalidade);
                }
                if (filters.professor) {
                    data = data.filter(c => c.professor === filters.professor);
                }
                if (filters.horario) {
                    data = data.filter(c => c.horario === filters.horario);
                }

                // 4. Atualiza a variﾃ｡vel global (assumindo que seja 'allCheckins' ou 'CHECKIN_HISTORY')
                window.allCheckins = data; // Use 'window.allCheckins' ou 'window.CHECKIN_HISTORY'
                
                console.log(`Histﾃｳrico de check-ins carregado do Firestore. Total: ${data.length}`);
                return data;

            } catch (e) {
                console.error("Erro ao carregar histﾃｳrico do Firestore:", e);
                showMessageBox('Erro de Carga', 'Nﾃ｣o foi possﾃｭvel carregar o histﾃｳrico de check-ins da nuvem.', 'error');
                return getCheckinsLocal(filters); // Tenta buscar localmente em caso de erro
            }
        }

        // **NOVO:** Funﾃｧﾃ｣o auxiliar (IndexedDB) para o fallback/migraﾃｧﾃ｣o:
        async function getCheckinsLocal(filters = {}) {
            if (!dbInstance) await openDB();
            return new Promise((resolve, reject) => {
                // (Mantenha o cﾃｳdigo original do IndexedDB aqui, com os filtros, se necessﾃ｡rio)
                // ... Seu cﾃｳdigo original para getCheckins
                const transaction = dbInstance.transaction([STORE_CHECKINS], 'readonly');
                const store = transaction.objectStore(STORE_CHECKINS);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    let data = event.target.result.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Aplica todos os filtros conforme o seu cﾃｳdigo original
                    if (filters.userId) data = data.filter(c => c.userId === filters.userId);
                    if (filters.startDate) { /* ... lﾃｳgica de filtro de data ... */ }
                    // ... todos os outros filtros ...

                    // allCheckins = data; // Se vocﾃｪ usa allCheckins localmente, atualize-a aqui
                    resolve(data);
                };
                request.onerror = () => resolve([]);
            });
        }




        // **NOVO:** Funﾃｧﾃ｣o auxiliar (IndexedDB) para o fallback, se necessﾃ｡rio:
        async function addCheckinLocal(checkinData) {
            if (!dbInstance) await openDB();
            return new Promise((resolve, reject) => {
                const transaction = dbInstance.transaction([STORE_CHECKINS], 'readwrite');
                const store = transaction.objectStore(STORE_CHECKINS);
                const dataToSave = { ...checkinData, timestamp: Date.now() }; // Usa timestamp local
                const request = store.add(dataToSave);
                request.onsuccess = () => resolve();
                request.onerror = (e) => {
                    console.error('Falha crﾃｭtica ao salvar check-in localmente.', e);
                    reject(e);
                };
            });
        }


        async function clearAllCheckins() {
            if (!FIREBASE_DB) throw new Error("Firestore nﾃ｣o estﾃ｡ inicializado.");

            try {
                // O Firestore nﾃ｣o tem uma funﾃｧﾃ｣o de "apagar tudo". Usamos batch delete:
                const snapshot = await FIREBASE_DB.collection(STORE_CHECKINS).get();
                const batch = FIREBASE_DB.batch(); 

                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit(); // Executa todas as exclusﾃｵes

                // Limpa a variﾃ｡vel global
                window.allCheckins = []; 
                
                // Tenta limpar o IndexedDB local (boa prﾃ｡tica)
                await clearLocalCheckinsCache(); 
                
                console.log('Todo o histﾃｳrico de check-ins foi apagado do Firestore e do cache.');

            } catch (e) {
                console.error('Erro ao limpar histﾃｳrico do Firestore:', e);
                showMessageBox('Erro', 'Falha ao limpar histﾃｳrico na nuvem.', 'error');
                // Vocﾃｪ pode relanﾃｧar o erro ou apenas avisar:
                throw new Error('Falha ao limpar histﾃｳrico na nuvem.');
            }
        }

        // **NOVO:** Funﾃｧﾃ｣o auxiliar para limpar cache local:
        async function clearLocalCheckinsCache() {
            if (!dbInstance) await openDB();
            return new Promise((resolve, reject) => {
                const transaction = dbInstance.transaction([STORE_CHECKINS], 'readwrite');
                const store = transaction.objectStore(STORE_CHECKINS);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (e) => {
                    console.warn('Aviso: Falha ao limpar cache local de check-ins.', e);
                    resolve(); 
                };
            });
        }



        // --- Funﾃｧﾃｵes de UI (Gerais) (SEM ALTERAﾃﾃグ) ---

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId)?.classList.remove('hidden');
        }

        async function showAdminSubView(subViewId) { // << AGORA ﾃ ASYNC
            document.querySelectorAll('#admin-sub-views > .sub-view').forEach(view => view.classList.add('hidden'));
            const targetView = document.getElementById(subViewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            
            // NOVO: Para qualquer troca de tela, limpa o intervalo de atualizaﾃｧﾃ｣o
            if (classRefreshInterval) {
                clearInterval(classRefreshInterval);
                classRefreshInterval = null;
            }

            // Aﾃｧﾃ｣o especﾃｭfica ao mudar de tela admin
            if (subViewId === 'admin-manage-students-view') {
                renderStudentManagementTable();
                populateRegistrationOptions(true); 
            } else if (subViewId === 'admin-manage-schedule-view') {
                renderScheduleManagementTable();
            } else if (subViewId === 'admin-history-view') {
                populateFilterOptions();
                renderCheckinHistory();
            } else if (subViewId === 'admin-quick-checkin-view') {
                document.getElementById('quickCheckinStudentId').value = '';
                document.getElementById('quickCheckinStudentId').focus();
                
                // Inicializa a lista e o refresh
                await getCheckins(); // Garante dados de ocupaﾃｧﾃ｣o atualizados
                renderAvailableClasses();
                
                // Auto-refresh a cada 30 segundos para manter a lista e o tempo atualizados
                classRefreshInterval = setInterval(async () => {
                    if (document.getElementById('admin-quick-checkin-view').classList.contains('hidden')) {
                        clearInterval(classRefreshInterval); // Safety check
                        classRefreshInterval = null;
                        return;
                    }
                    await getCheckins(); 
                    renderAvailableClasses();
                }, 30000); 

            }
            // Esconde os formulﾃ｡rios de ediﾃｧﾃ｣o ao mudar de sub-view
            document.getElementById('edit-student-form-container').classList.add('hidden');
            document.getElementById('edit-class-form-container').classList.add('hidden');
        }
        
        function closeMessageBox() {
            document.getElementById('messageOverlay').classList.add('hidden');
        }

        function showMessageBox(title, detail, type = 'info') {
            const overlay = document.getElementById('messageOverlay');
            const box = document.getElementById('messageBox');
            const titleEl = document.getElementById('messageTitle');
            const detailEl = document.getElementById('messageDetail');
            const closeBtn = overlay.querySelector('button'); 

            // 1. Reset classes (base de estilo do modal)
            box.className = 'p-6 rounded-lg shadow-xl w-full max-w-sm transition duration-300 ease-in-out transform scale-100';
            closeBtn.className = 'w-full p-2 rounded font-semibold transition duration-150 ease-in-out';

            // 2. Aplica classes de cor e borda
            if (type === 'success') {
                box.classList.add('bg-white', 'border-4', 'border-green-500'); 
                titleEl.classList.add('text-green-700');
                closeBtn.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
            } else if (type === 'error') {
                box.classList.add('bg-white', 'border-4', 'border-red-500');
                titleEl.classList.add('text-red-700');
                closeBtn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
            } else if (type === 'warning') {
                box.classList.add('bg-white', 'border-4', 'border-yellow-500');
                titleEl.classList.add('text-yellow-700');
                closeBtn.classList.add('bg-yellow-500', 'text-white', 'hover:bg-yellow-600');
            } else { // Default/info
                box.classList.add('bg-white', 'border-4', 'border-indigo-500');
                titleEl.classList.add('text-indigo-700');
                closeBtn.classList.add('bg-indigo-500', 'text-white', 'hover:bg-indigo-600');
            }
            
            // 3. Define o conteﾃｺdo
            titleEl.textContent = title;
            detailEl.innerHTML = detail;

            // 4. Exibe o overlay
            overlay.classList.remove('hidden');
        }

        // --- Funﾃｧﾃｵes de Populaﾃｧﾃ｣o de Selects (SEM ALTERAﾃﾃグ) ---

        function populateRegistrationOptions() {
            const selectEl = document.getElementById('edit-enrollment');
            if (!selectEl) return;

            // 1. Limpa as opﾃｧﾃｵes existentes
            selectEl.innerHTML = '';
            
            // 2. Agrupa e ordena as aulas por Modalidade, Dia e Horﾃ｡rio
            const groupedClasses = {};

            // O ALL_CLASS_OPTIONS deve conter todos os objetos de aula (com id, modalidade, dia, horario, etc.)
            ALL_CLASS_OPTIONS.forEach(aula => {
                const category = aula.modalidade; // Agrupa pelo nome da modalidade

                if (!groupedClasses[category]) {
                    groupedClasses[category] = [];
                }
                groupedClasses[category].push(aula);
            });
            
            // 3. Itera sobre os grupos para construir o HTML
            let htmlOptions = '';

            // Ordena os grupos (Modalidades) por nome
            const sortedCategories = Object.keys(groupedClasses).sort((a, b) => a.localeCompare(b));

            sortedCategories.forEach(category => {
                const aulas = groupedClasses[category];
                
                // Ordena as aulas dentro de cada grupo por Dia e depois por Horﾃ｡rio
                aulas.sort((a, b) => {
                    const dayOrderA = DAYS_OF_WEEK_PT.indexOf(a.dia);
                    const dayOrderB = DAYS_OF_WEEK_PT.indexOf(b.dia);
                    
                    if (dayOrderA !== dayOrderB) {
                        return dayOrderA - dayOrderB;
                    }
                    // Se o dia ﾃｩ o mesmo, ordena pelo horﾃ｡rio
                    return a.horario.localeCompare(b.horario);
                });
                
                // Abre o grupo de opﾃｧﾃｵes com o nome da Modalidade
                htmlOptions += `<optgroup label="${category}">`;

                aulas.forEach(aula => {
                    // Formato da exibiﾃｧﾃ｣o: [Dia - Horﾃ｡rio] (Professor)
                    const label = aula.token === "MUSC" 
                        ? `${aula.modalidade} (${aula.professor})` // Nﾃ｣o precisa de dia/hora se for Musculaﾃｧﾃ｣o
                        : `${aula.dia} - ${aula.horario} | Prof: ${aula.professor}`;

                    // O valor da opﾃｧﾃ｣o ﾃｩ o ID ﾃｺnico (necessﾃ｡rio para o salvamento)
                    htmlOptions += `<option value="${aula.id}">${label}</option>`;
                });

                // Fecha o grupo de opﾃｧﾃｵes
                htmlOptions += `</optgroup>`;
            });

            selectEl.innerHTML = htmlOptions;
            
            // Opcional: Atualiza o tamanho do seletor se for necessﾃ｡rio (depende do seu CSS)
            selectEl.classList.add('select-multiple-height');
            selectEl.setAttribute('multiple', true);
        }

        


        // --- Funﾃｧﾃｵes de Grade de Horﾃ｡rios (Admin/Modal) (SEM ALTERAﾃﾃグ) ---

        function renderGradeModal() {
            const gradeContent = document.getElementById('gradeContent');
            gradeContent.innerHTML = '';
            let classesFound = false;

            const sortedModalidades = Object.keys(GRADE_SCHEDULE_RUNTIME).sort();

            for (const modalidade of sortedModalidades) {
                const daysSchedule = GRADE_SCHEDULE_RUNTIME[modalidade];
                let modalidadeHTML = '';
                
                const sortedDays = Object.keys(daysSchedule).sort((a, b) => DAY_ORDER_MAP[a] - DAY_ORDER_MAP[b]);

                for (const day of sortedDays) {
                    const classes = daysSchedule[day];
                    classesFound = true;
                    let classesListHTML = '';
                    
                    classes.sort((a, b) => a.horario.localeCompare(b.horario)).forEach(aula => {
                        const horarioDisplay = aula.horario;
                        const tokenDisplay = aula.token;
                        classesListHTML += `<li>${horarioDisplay} <span class="text-gray-500 text-xs">(${tokenDisplay})</span></li>`;
                    });

                    if (classesListHTML) {
                        modalidadeHTML += ` 
                            <div class="p-2 border-b last:border-b-0">
                                <p class="font-semibold text-gray-800">${day}:</p>
                                <ul class="list-disc ml-5 text-sm">
                                    ${classesListHTML}
                                </ul>
                            </div>
                        `;
                    }
                }

                if (modalidadeHTML) {
                    gradeContent.innerHTML += `
                        <h4 class="text-lg font-bold text-indigo-700 mt-4 mb-2 p-2 bg-indigo-50">${modalidade}</h4>
                        ${modalidadeHTML}
                    `;
                }
            }

            if (!classesFound) {
                gradeContent.innerHTML = `<p class="p-4 text-gray-600 italic">Nenhuma aula na grade de horﾃ｡rios para exibir.</p>`;
            }

            document.getElementById('gradeModal').classList.remove('hidden');
        }

        // --- Funﾃｧﾃｵes de Utilitﾃ｡rios de Checagem de Aula ---

        function isCurrentTimeInMuscRange(horarioRange) {
            const parts = horarioRange.split(' - ');
            if (parts.length !== 2) return false;

            const [startStr, endStr] = parts;
            const now = new Date();
            const today = now.toLocaleDateString('en-CA'); 

            const parseTime = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                const date = new Date(`${today} ${timeStr}`);
                date.setHours(h, m, 0, 0); 
                return date;
            };

            let startTime = parseTime(startStr);
            let endTime = parseTime(endStr);
            
            // Lida com horﾃ｡rios que passam da meia-noite (embora improvﾃ｡vel)
            if (endTime < startTime) {
                endTime.setDate(endTime.getDate() + 1);
            }

            return now >= startTime && now <= endTime;
        }

        function isClassAvailableNow(aula) {
             if (aula.token === "MUSC") {
                 return isCurrentTimeInMuscRange(aula.horario);
             }

             const now = new Date();
             const today = now.toLocaleDateString('en-CA'); 
             const [hourStr, minuteStr] = aula.horario.split(':');
             
             const classStartTime = new Date(`${today} ${aula.horario}`);
             classStartTime.setHours(Number(hourStr), Number(minuteStr), 0, 0);

             const windowStart = new Date(classStartTime.getTime() - JANELA_ANTES_MINUTOS * 60000);
             const windowEnd = new Date(classStartTime.getTime() + JANELA_DEPOIS_MINUTOS * 60000);

             return now >= windowStart && now <= windowEnd;
        }

        function getAvailableClassesForQuickCheckin() {
            const now = new Date();
            const todayDay = DAYS_OF_WEEK_PT[now.getDay()];
            const availableClasses = [];

            for (const modalidade in GRADE_SCHEDULE_RUNTIME) {
                if (GRADE_SCHEDULE_RUNTIME[modalidade][todayDay]) {
                    GRADE_SCHEDULE_RUNTIME[modalidade][todayDay].forEach(aula => {
                        if (isClassAvailableNow(aula)) {
                            availableClasses.push(aula);
                        }
                    });
                }
            }
            return availableClasses;
        }
        
        // --- NOVO: Renderiza a lista de aulas abertas ---
        function renderAvailableClasses() {
            const listEl = document.getElementById('available-classes-list');
            if (!listEl) return;

            const availableClasses = getAvailableClassesForQuickCheckin();

            if (availableClasses.length === 0) {
                listEl.innerHTML = `<p class="text-gray-600 p-2 italic">Nenhuma aula aberta no momento (fora da janela de ${JANELA_ANTES_MINUTOS} minutos antes / ${JANELA_DEPOIS_MINUTOS} minutos depois).</p>`;
                return;
            }

            let html = '';
            
            // Ordena pela hora de inﾃｭcio (Musculaﾃｧﾃ｣o primeiro)
            availableClasses.sort((a, b) => {
                if (a.token === "MUSC") return -1; 
                if (b.token === "MUSC") return 1;
                return a.horario.localeCompare(b.horario);
            });

            const todayLocaleDate = new Date().toLocaleDateString('pt-BR');

            availableClasses.forEach(aula => {
                let timeDisplay;
                let details;
                const now = new Date();
                const [hour, minute] = aula.horario.split(':').map(Number);
                const classTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute);

                if (aula.token === "MUSC") {
                    timeDisplay = `<span class="font-bold text-green-700">Aberto Agora</span>`;
                    details = `${aula.horario} | Prof: ${aula.professor}`;
                } else {
                    const timeDiffMinutes = Math.round((classTime.getTime() - now.getTime()) / 60000);
                    
                    if (timeDiffMinutes >= 0) {
                        timeDisplay = `<span class="font-bold text-yellow-700">Comeﾃｧa em ${timeDiffMinutes} min</span>`;
                    } else {
                        // Estﾃ｡ na janela de DEPOIS (check-in atrasado)
                        timeDisplay = `<span class="font-bold text-red-700">Atrasado (${-timeDiffMinutes} min)</span>`;
                    }
                    details = `${aula.dia}, ${aula.horario} | Prof: ${aula.professor}`;
                }
                
                // Exibe a informaﾃｧﾃ｣o de ocupaﾃｧﾃ｣o (apenas para aulas nﾃ｣o-MUSC)
                let occupancyDisplay = '';
                if (aula.token !== "MUSC") {
                     const currentOccupancy = allCheckins.filter(c => {
                        const checkinDate = new Date(c.timestamp).toLocaleDateString('pt-BR');
                        // Conta ocupaﾃｧﾃ｣o para a aula especﾃｭfica (modalidade e horﾃ｡rio) e que ocorreu HOJE.
                        return c.modalidade === aula.modalidade && c.horario === aula.horario && checkinDate === todayLocaleDate;
                    }).length;
                    
                    const capacity = aula.capacidade;
                    occupancyDisplay = ` - Ocupaﾃｧﾃ｣o: <span class="${currentOccupancy >= capacity ? 'text-red-600 font-bold' : 'font-medium'}">${currentOccupancy}/${capacity}</span>`;
                }


                html += `
                    <div class="p-2 flex justify-between items-center text-sm">
                        <div>
                            <p class="font-semibold text-gray-900">${aula.modalidade}</p>
                            <p class="text-gray-600">${details}${occupancyDisplay}</p>
                        </div>
                        <div class="flex-shrink-0">
                            ${timeDisplay}
                        </div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        }


        // --- NOVA FUNﾃﾃグ: Encontra a aula mais adequada para o check-in automﾃ｡tico ---
        function findStudentCheckinTarget(profile) {
            console.log("--- INICIANDO VALIDAﾃﾃグ DE CHECK-IN ---");
            
            // ************ CORREﾃﾃグ DE ESTRUTURA DE DADOS ************
            // Transforma o enrollment (que pode ser objetos {id, name}) em uma lista simples de IDs
            const studentEnrollmentIds = (profile.enrollment || []).map(c => c.id || c); 
            console.log(`Matrﾃｭculas do aluno ${profile.name} (IDs):`, studentEnrollmentIds); // LOG 1: Conteﾃｺdo da Matrﾃｭcula
            console.log(`Matrﾃｭculas do aluno (Full Data):`, profile.enrollment); // LOG 2: Conteﾃｺdo Bruto da Matrﾃｭcula
            // ********************************************************
            
            // 1. Checagem de Expiraﾃｧﾃ｣o
            const status = getExpirationStatus(profile.expiryDate);
            if (status.expired) {
                console.error(`VALIDAﾃﾃグ FALHOU: Matrﾃｭcula de ${profile.name} venceu em ${status.display}.`);
                return { success: false, message: `Matrﾃｭcula do aluno **${profile.name}** venceu em ${status.display}. Acesso negado.` };
            }

            console.log(`Status de matrﾃｭcula de ${profile.name}: ATIVA.`);
            
            // 2. Busca de Aulas Disponﾃｭveis no Momento (Janela de 15 min antes / 30 min depois)
            const availableClasses = getAvailableClassesForQuickCheckin();
            console.log("Aulas disponﾃｭveis no momento (Janela de Check-in):", availableClasses); // LOG 3: Aulas Abertas
            
            if (availableClasses.length === 0) {
                console.warn("VALIDAﾃﾃグ FALHOU: Nenhuma aula aberta agora.");
                return { success: false, message: 'Nenhuma aula disponﾃｭvel para check-in no momento.' };
            }

            // 3. Filtrar Aulas Disponﾃｭveis pela Matrﾃｭcula do Aluno
            const validClasses = [];
            
            availableClasses.forEach(aula => {
                // Checa a matrﾃｭcula na aula especﾃｭfica (pelo ID ﾃｺnico da aula)
                if (aula.token !== "MUSC") {
                    if (studentEnrollmentIds.includes(aula.id)) { 
                        console.log(`ALUNO OK: Matriculado na aula especﾃｭfica: ${aula.modalidade} em ${aula.dia} ${aula.horario}.`);
                        validClasses.push(aula);
                    }
                // Checa a matrﾃｭcula em Musculaﾃｧﾃ｣o (pelo token 'MUSC')
                } else if (aula.token === "MUSC") {
                    const isEnrolledInMusculacao = studentEnrollmentIds.some(enrollmentId => {
                        const enrolledClass = ALL_CLASS_OPTIONS.find(a => a.id === enrollmentId); 
                        return enrolledClass && enrolledClass.token === "MUSC";
                    }); 
                    if (isEnrolledInMusculacao) { 
                        console.log(`ALUNO OK: Matriculado em Musculaﾃｧﾃ｣o (token: MUSC).`);
                        if (!validClasses.some(c => c.token === "MUSC")) {
                            validClasses.push(aula); 
                        }
                    } 
                } 
            }); 
            
            // ... (Continuaﾃｧﾃ｣o da funﾃｧﾃ｣o para resolver conflitos e dar o resultado final) ...

            console.log("Aulas Vﾃ｡lidas para Check-in (apﾃｳs filtro de matrﾃｭcula):", validClasses);

            if (validClasses.length === 0) { 
                // *** LOG DE FALHA COM INFO COMPLETA ***
                console.error("DEBUG FATAL: Nﾃ｣o foi possﾃｭvel casar. Aulas Abertas:", availableClasses);
                console.error("DEBUG FATAL: Matrﾃｭculas do Aluno:", profile.enrollment);
                // **********************************************
                console.error("VALIDAﾃﾃグ FALHOU: Nenhuma aula disponﾃｭvel corresponde ﾃ matrﾃｭcula do aluno.");
                return { success: false, message: 'Nenhuma aula disponﾃｭvel para check-in no momento em que o aluno estﾃ｡ matriculado.' }; 
            } 
            
            // 4. Resoluﾃｧﾃ｣o de Conflitos e Prioridade (Lﾃｳgica da Academia)
            const muscClass = validClasses.find(c => c.token === "MUSC"); 
            const nonMuscClasses = validClasses.filter(c => c.token !== "MUSC"); 
            
            let targetClass = null;

            // Prioridade 1: Aulas especﾃｭficas (non-MUSC)
            if (nonMuscClasses.length === 1) { 
                targetClass = nonMuscClasses[0];
            } else if (nonMuscClasses.length > 1) {
                console.error("VALIDAﾃﾃグ FALHOU: Conflito. Mais de uma aula especﾃｭfica aberta.");
                return { success: false, message: 'Conflito de Agendamento. Mais de uma aula especﾃｭfica disponﾃｭvel para check-in. Contate o administrador.' }; 
            } 
            
            // Prioridade 2: Apenas Musculaﾃｧﾃ｣o
            if (!targetClass && muscClass) {
                targetClass = muscClass;
            } 
            
            if (targetClass) {
                console.log(`Check-in de ${profile.name} Vﾃ´IDO para: ${targetClass.modalidade} (${targetClass.horario}).`);
                // REGISTRA O CHECK-IN AQUI
                return { success: true, classInstance: targetClass };
            }
            
            console.error("VALIDAﾃﾃグ FALHOU: Cenﾃ｡rio de validaﾃｧﾃ｣o nﾃ｣o resolvido.");
            return { success: false, message: 'Nﾃ｣o foi possﾃｭvel determinar a aula para check-in. (Erro Interno)' };
        }

        // --- NOVA FUNﾃﾃグ: Lﾃｳgica de Registro de Check-in (Substitui o core da antiga handleCheckin) ---
        async function registerCheckin(profile, classInstance) {
            
            // 1. Checagem de Duplicidade (Check-in jﾃ｡ realizado hoje para esta aula)
            const now = new Date();
            const today = now.toLocaleDateString('pt-BR');
            const checkinAlreadyDone = allCheckins.some(c => {
                const checkinDate = new Date(c.timestamp).toLocaleDateString('pt-BR');
                // Checa se o aluno fez checkin na mesma modalidade E horﾃ｡rio hoje (importante para evitar checkin em duas aulas especﾃｭficas seguidas)
                return c.userId === profile.id && c.modalidade === classInstance.modalidade && c.horario === classInstance.horario && checkinDate === today;
            });

            if (checkinAlreadyDone) {
                showMessageBox('Aviso', `Aluno **${profile.name}** jﾃ｡ realizou check-in em **${classInstance.modalidade} (${classInstance.horario})** hoje.`, 'warning');
                return;
            }

            // 2. Contagem de Ocupaﾃｧﾃ｣o (Para aulas com capacidade limitada)
            if (classInstance.token !== "MUSC") {
                const currentOccupancy = allCheckins.filter(c => {
                    const checkinDate = new Date(c.timestamp).toLocaleDateString('pt-BR');
                    // Conta ocupaﾃｧﾃ｣o apenas para a aula especﾃｭfica (modalidade e horﾃ｡rio)
                    return c.modalidade === classInstance.modalidade && c.horario === classInstance.horario && checkinDate === today;
                }).length;

                if (currentOccupancy >= classInstance.capacidade) {
                    showMessageBox('Aviso', `A aula de **${classInstance.modalidade} (${classInstance.horario})** atingiu a capacidade mﾃ｡xima (${classInstance.capacidade}). Check-in recusado.`, 'error'); // Mudado para erro (bloqueia o check-in)
                    return;
                }
            }

            // 3. Registro do Check-in
            try {
                const checkinData = {
                    userId: profile.id,
                    name: profile.name,
                    token: classInstance.token,
                    modalidade: classInstance.modalidade,
                    professor: classInstance.professor,
                    horario: classInstance.horario,
                };
                await addCheckin(checkinData);
                showMessageBox('Check-in Efetuado!', `Aluno **${profile.name}** check-in na aula de **${classInstance.modalidade} (${classInstance.horario})**!`, 'success');
                
                // Limpa o campo do ID do aluno e foca para o prﾃｳximo
                document.getElementById('quickCheckinStudentId').value = ''; 
                document.getElementById('quickCheckinStudentId').focus(); 
                
                // Atualiza o histﾃｳrico de check-ins, se a view estiver aberta.
                if (document.getElementById('admin-history-view').classList.contains('hidden') === false) {
                     renderCheckinHistory();
                }
                
                // NOVO: Atualiza a lista de aulas abertas para refletir a nova ocupaﾃｧﾃ｣o.
                await getCheckins(); 
                renderAvailableClasses(); 

            } catch (e) {
                showMessageBox('Erro', `Falha ao registrar check-in: ${e.message}`, 'error');
            }
        }


        // --- NOVA FUNﾃﾃグ: Processo Completo de Check-in Automﾃ｡tico (Chamada pelo Botﾃ｣o/Scanner) ---
        async function processAutomaticCheckin(studentId) {
            // 1. Validar ID
            if (!studentId) {
                showMessageBox('Aviso', 'Preencha o ID do Aluno (ou use o scanner).', 'warning');
                return;
            }
            
            // 2. Obter Perfil
            const profile = await getProfile(studentId);
            if (!profile) {
                showMessageBox('Erro', `Aluno com ID **${studentId}** nﾃ｣o encontrado.`, 'error');
                return;
            }

            // 3. Checagem de Mensalidade
            const status = getExpirationStatus(profile.expiryDate);
            if (status.expired) {
                showMessageBox('Acesso Negado', `O aluno **${profile.name}** estﾃ｡ com mensalidade vencida desde ${status.display}.`, 'error');
                return;
            }

            // 4. Encontrar a Aula Vﾃ｡lida (ﾃ嗜ica)
            const target = findStudentCheckinTarget(profile);
            
            if (!target.success) {
                // Exibe a mensagem de erro/aviso da funﾃｧﾃ｣o target
                showMessageBox(target.message.includes('Conflito') ? 'Conflito de Agendamento' : 'Acesso Negado', target.message, 'error');
                return;
            }
            
            // 5. Registrar Check-in
            await registerCheckin(profile, target.classInstance);
        }


        function closeQrCodeModal() {
            document.getElementById('qrCodeModal').classList.add('hidden');
        }

        // --- Funﾃｧﾃｵes de Admin (Scanner) ---

        function closeAdminScannerModal() {
            document.getElementById('adminScannerModal').classList.add('hidden');
            if (qrCodeScannerAdmin && qrCodeScannerAdmin.getState() === 2) { 
                qrCodeScannerAdmin.stop().catch(console.error);
            }
        }

        const onAdminScanSuccess = async (decodedText) => {
            closeAdminScannerModal();
            const studentId = decodedText;
            await processAutomaticCheckin(studentId);
        };

        const onAdminScanFailure = (errorMessage) => {
            // Silencioso.
        };

        // --- SIMPLIFICADO E ROBUSTO: Inicializaﾃｧﾃ｣o Direta do Scanner ---
        function openAdminScannerModal() {
            const modalEl = document.getElementById('adminScannerModal');
            modalEl.classList.remove('hidden');
            const readerEl = document.getElementById('admin-qr-reader');
            readerEl.innerHTML = '';
            const statusEl = document.getElementById('admin-qr-status');
            statusEl.textContent = "Escanear QR Code do Aluno...";

            // 1. Verificaﾃｧﾃ｣o da biblioteca
            if (typeof Html5Qrcode === 'undefined') {
                 statusEl.textContent = "ERRO: A biblioteca de QR Code nﾃ｣o foi carregada. Por favor, inclua o arquivo localmente.";
                 console.error("Html5Qrcode nﾃ｣o estﾃ｡ definido.");
                 return;
            }
            
            // 2. Instanciaﾃｧﾃ｣o
            if (!qrCodeScannerAdmin) {
                qrCodeScannerAdmin = new Html5Qrcode("admin-qr-reader");
            }

            // 3. Inicia o scanner, permitindo que o navegador escolha o dispositivo padrﾃ｣o
            qrCodeScannerAdmin.start(
                { facingMode: { ideal: "environment" } }, // Preferﾃｪncia pela cﾃ｢mera traseira/ambiente, mas nﾃ｣o obrigatﾃｳrio
                QR_SCANNER_CONFIG, 
                onAdminScanSuccess, 
                onAdminScanFailure
            ).catch(err => {
                console.error("Erro ao iniciar scanner:", err);
                statusEl.textContent = "ERRO: Nﾃ｣o foi possﾃｭvel iniciar a cﾃ｢mera. Verifique permissﾃｵes (HTTPS), se a webcam estﾃ｡ conectada e disponﾃｭvel.";
            });
        }    
                    


        // --- Funﾃｧﾃｵes de Admin (Histﾃｳrico) (SEM ALTERAﾃﾃグ) ---

        async function renderCheckinHistory() {
            // Obtﾃｩm o termo de pesquisa do novo campo de input
            const searchHistoryTerm = document.getElementById('searchStudentHistory').value.toLowerCase().trim();
            
            const historyContent = document.getElementById('historyContent');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const countDisplay = document.getElementById('countDisplay');
            loadingIndicator.classList.remove('hidden');
            historyContent.innerHTML = '';
            countDisplay.textContent = '0';

            try {
                const filters = {
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    modalidade: document.getElementById('modalidadeFilter').value,
                    professor: document.getElementById('professorFilter').value,
                    horario: document.getElementById('horarioFilter').value
                };
                
                // 1. Busca os check-ins baseados nos filtros de data/aula
                const checkinsFromDB = await getCheckins(filters);
                
                // 2. Aplica o filtro de pesquisa por nome/ID do aluno (NOVO)
                let checkinsToRender = checkinsFromDB;

                if (searchHistoryTerm) {
                    checkinsToRender = checkinsFromDB.filter(checkin => {
                        const nameMatch = checkin.name.toLowerCase().includes(searchHistoryTerm);
                        // Verifica o ID do aluno. O seu cﾃｳdigo usa 'userId' para o ID do aluno.
                        const idMatch = checkin.userId.toLowerCase().includes(searchHistoryTerm); 
                        return nameMatch || idMatch;
                    });
                }

                countDisplay.textContent = checkinsToRender.length; // Usa o total apﾃｳs todos os filtros

                if (checkinsToRender.length === 0) {
                    historyContent.innerHTML = '<p class="text-gray-500 p-4">Nenhum registro de check-in encontrado com os filtros aplicados.</p>';
                    loadingIndicator.classList.add('hidden');
                    return;
                }

                // --- Geraﾃｧﾃ｣o do HTML (usando checkinsToRender) ---
                let html = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 shadow overflow-hidden sm:rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aluno (ID)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aula</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Horﾃ｡rio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Professor</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;

                // Loop modificado para usar a lista final filtrada
                checkinsToRender.forEach(checkin => { 
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatTimestamp(checkin.timestamp)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600">${checkin.name} <span class="text-gray-500 text-xs">(${checkin.userId})</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${checkin.modalidade}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${checkin.horario}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${checkin.professor}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
                historyContent.innerHTML = html;

            } catch (e) {
                historyContent.innerHTML = `<p class="p-4 text-red-500">Erro ao carregar histﾃｳrico: ${e.message}</p>`;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        async function populateFilterOptions() {
            const modalidadeSet = new Set();
            const professorSet = new Set();
            const horarioSet = new Set();

            ALL_CLASS_OPTIONS.forEach(aula => {
                modalidadeSet.add(aula.modalidade);
                professorSet.add(aula.professor);
                horarioSet.add(aula.horario);
            });

            const populateSelect = (selectId, dataSet) => {
                const selectEl = document.getElementById(selectId);
                if (!selectEl) return;
                selectEl.innerHTML = '<option value="">Todos</option>';
                const sortedData = Array.from(dataSet).sort();
                sortedData.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item;
                    opt.textContent = item;
                    selectEl.appendChild(opt);
                });
            };

            populateSelect('modalidadeFilter', modalidadeSet);
            populateSelect('professorFilter', professorSet);
            populateSelect('horarioFilter', horarioSet);
        }

        function clearAllFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('modalidadeFilter').value = '';
            document.getElementById('professorFilter').value = '';
            document.getElementById('horarioFilter').value = '';
            renderCheckinHistory();
        }

        // --- Funﾃｧﾃｵes de Gerenciamento de Grade (Admin UI) (SEM ALTERAﾃﾃグ) ---

        function generateClassId(modalidade, dia, horario, professor) {
            const mod = modalidade.substring(0, 4).toUpperCase();
            const day = dia.substring(0, 3).toUpperCase();
            const time = horario.replace(/[^0-9]/g, '').slice(0, 4);
            const prof = professor.substring(0, 3).toUpperCase();
            return `${mod}-${day}-${time}-${prof}-${Date.now().toString().slice(-4)}`;
        }

        function renderScheduleManagementTable() {
            const container = document.getElementById('schedule-list-container');
            container.innerHTML = '';

            const classesByModalidade = ALL_CLASS_OPTIONS.reduce((acc, aula) => {
                if (!acc[aula.modalidade]) {
                    acc[aula.modalidade] = [];
                }
                acc[aula.modalidade].push(aula);
                return acc;
            }, {});

            const sortedModalidades = Object.keys(classesByModalidade).sort();

            let html = '';

            sortedModalidades.forEach(modalidade => {
                const sortedClasses = classesByModalidade[modalidade].sort((a, b) => {
                    const dayA = DAY_ORDER_MAP[a.dia];
                    const dayB = DAY_ORDER_MAP[b.dia];
                    if (dayA !== dayB) return dayA - dayB;
                    return a.horario.localeCompare(b.horario);
                });

                html += `
                    <div class="bg-white border rounded-lg shadow-sm mb-4">
                        <h4 class="text-lg font-bold p-3 bg-indigo-100 text-indigo-800 rounded-t-lg">${modalidade} <span class="text-sm font-normal text-gray-600">(${sortedClasses.length} Horﾃ｡rios)</span></h4>
                        <div class="divide-y divide-gray-200">
                `;

                sortedClasses.forEach(aula => {
                    const statusClass = aula.token === 'MUSC' ? 'text-green-600 font-medium' : 'text-blue-600';
                    const tokenDisplay = `<span class="${statusClass}">${aula.token}</span>`;
                    
                    html += `
                        <div class="p-3 flex justify-between items-center hover:bg-gray-50">
                            <div>
                                <p class="text-base font-semibold text-gray-900">${aula.dia} ${aula.horario}</p>
                                <p class="text-sm text-gray-600">Prof: ${aula.professor} | Capacidade: ${aula.capacidade} | Token: ${tokenDisplay}</p>
                            </div>
                            <div class="space-x-2 flex-shrink-0">
                                <button onclick="editClass('${aula.id}')" class="px-3 py-1 text-sm bg-yellow-500 text-white rounded hover:bg-yellow-600">Editar</button>
                                <button onclick="deleteClass('${aula.id}')" class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600">Excluir</button>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            if (Object.keys(classesByModalidade).length === 0) {
                 html = '<p class="text-gray-500 p-4">Nenhuma aula cadastrada na grade.</p>';
            }

            container.innerHTML = html;
        }

        function editClass(id) {
             const classInstance = ALL_CLASS_OPTIONS.find(a => a.id === id);
            if (!classInstance) return;

            document.getElementById('edit-class-id-holder').value = classInstance.id;
            document.getElementById('edit-class-form-title').textContent = `Editar Aula: ${classInstance.modalidade} - ${classInstance.dia} ${classInstance.horario}`;
            document.getElementById('edit-class-modalidade').value = classInstance.modalidade;
            document.getElementById('edit-class-dia').value = classInstance.dia;
            document.getElementById('edit-class-horario').value = classInstance.horario;
            document.getElementById('edit-class-professor').value = classInstance.professor;
            document.getElementById('edit-class-capacidade').value = classInstance.capacidade;
            document.getElementById('edit-class-token').value = classInstance.token;
            document.getElementById('edit-class-form-container').classList.remove('hidden');
        }

        async function saveClassFromAdmin() {
            const id = document.getElementById('edit-class-id-holder').value;
            const modalidade = document.getElementById('edit-class-modalidade').value.trim();
            const dia = document.getElementById('edit-class-dia').value;
            const horario = document.getElementById('edit-class-horario').value.trim();
            const professor = document.getElementById('edit-class-professor').value.trim();
            const capacidade = parseInt(document.getElementById('edit-class-capacidade').value);
            const token = document.getElementById('edit-class-token').value.trim().toUpperCase();

            if (!modalidade || !dia || !horario || !professor || isNaN(capacidade) || capacidade < 1 || !token) {
                showMessageBox('Erro de Cadastro', 'Por favor, preencha todos os campos corretamente.', 'warning');
                return;
            }

            const classId = id || generateClassId(modalidade, dia, horario, professor);

            const classToSave = {
                id: classId,
                modalidade,
                dia,
                horario,
                professor,
                capacidade,
                token
            };

            try {
                await saveClassInstance(classToSave);
                await loadScheduleFromDB(); 
                showMessageBox('Sucesso', `Aula ${modalidade} salva com sucesso!`, 'success');
                document.getElementById('edit-class-form-container').classList.add('hidden');
                renderScheduleManagementTable();
                populateRegistrationOptions();
                populateFilterOptions();
            } catch (e) {
                showMessageBox('Erro', `Falha ao salvar a aula: ${e.message}`, 'error');
            }
        }

        async function deleteClass(id) {
            const classInstance = ALL_CLASS_OPTIONS.find(a => a.id === id);
            if (!classInstance) return;

            if (!confirm(`Tem certeza que deseja EXCLUIR a aula ${classInstance.modalidade} em ${classInstance.dia} ${classInstance.horario}?`)) return;

            try {
                await deleteClassInstance(id);
                await loadScheduleFromDB(); 
                showMessageBox('Sucesso', 'Aula excluﾃｭda.', 'success');
                renderScheduleManagementTable();
                populateRegistrationOptions();
                populateFilterOptions();
            } catch (e) {
                showMessageBox('Erro', 'Falha ao excluir aula.', 'error');
            }
        }

        function filterStudentsAdmin() {
            const searchTerm = document.getElementById('searchStudentAdmin').value.toLowerCase().trim();
            
            // Se o termo de pesquisa estiver vazio, usa todos os perfis carregados (allProfiles)
            if (!searchTerm) {
                renderStudentManagementTable(allProfiles);
                return;
            }
            
            // Filtra os perfis
            const filteredProfiles = allProfiles.filter(profile => {
                const nameMatch = profile.name.toLowerCase().includes(searchTerm);
                const idMatch = profile.id.toLowerCase().includes(searchTerm);
                return nameMatch || idMatch;
            });
            
            // Renderiza a tabela com os resultados filtrados
            renderStudentManagementTable(filteredProfiles);
        }


        // --- Funﾃｧﾃｵes de Admin (Gerenciamento de Alunos) (SEM ALTERAﾃﾃグ) ---

                // A funﾃｧﾃ｣o agora usa ALL_STUDENTS_PROFILES, que ﾃｩ a variﾃ｡vel populada pelo Firestore
        function renderStudentManagementTable(profilesToRender = ALL_STUDENTS_PROFILES) { 
            // ^^^ CORREﾃﾃグ AQUI: Mudanﾃｧa de 'allProfiles' para 'ALL_STUDENTS_PROFILES' como padrﾃ｣o

            const container = document.getElementById('student-list-table');
            if (!container) return; 

            container.innerHTML = '';

            // Verifica o tamanho da lista carregada do Firestore
            if (ALL_STUDENTS_PROFILES.length === 0) { 
                container.innerHTML = '<p class="text-gray-500 p-4">Nenhum aluno cadastrado.</p>';
                return;
            }

            // Se o argumento 'profilesToRender' foi fornecido, usa ele. Caso contrﾃ｡rio, usa a lista global.
            const listToRender = profilesToRender === ALL_STUDENTS_PROFILES ? ALL_STUDENTS_PROFILES : profilesToRender;
            
            // Certifique-se de que a ordenaﾃｧﾃ｣o usa a lista correta
            const sortedProfiles = listToRender.sort((a, b) => a.name.localeCompare(b.name)); 

            // 1. Inicia a construﾃｧﾃ｣o da tabela (somente <thead>)
            let tableHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 shadow overflow-hidden sm:rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome (ID)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modalidades</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aﾃｧﾃｵes</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">`; 

            // 2. Loop para gerar as linhas (<tr>)
            sortedProfiles.forEach(profile => {
                const status = getExpirationStatus(profile.expiryDate);
                const statusClass = status.expired ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                const statusText = status.expired ? 'VENCIDA' : 'ATIVA';
                
                // --- Lﾃｳgica de Modalidades ---
                let classesDisplay = 'Nenhuma';
                // Adaptaﾃｧﾃ｣o para garantir que o campo 'enrollment' ou 'classes' seja lido
                const classesData = profile.enrollment || profile.classes; 
                // Adaptaﾃｧﾃ｣o para tratar se 'classesData' ﾃｩ um array de IDs ou um array de objetos {name, id}
                const enrolledClassesIDs = Array.isArray(classesData) ? classesData.map(c => c.id || c) : [];

                if (enrolledClassesIDs.length > 0) {
                    // 1. Buscar os detalhes completos de cada aula
                    const detailedClasses = enrolledClassesIDs
                        .map(id => ALL_CLASS_OPTIONS.find(aula => aula.id === id))
                        .filter(aula => aula); // Remove IDs nﾃ｣o encontrados

                    // 2. Aplicar a ordenaﾃｧﾃ｣o (Dia e Horﾃ｡rio)
                    detailedClasses.sort((a, b) => {
                        // ... (Sua lﾃｳgica de ordenaﾃｧﾃ｣o por Dia/Horﾃ｡rio - Mantida)
                        const dayOrderA = DAYS_OF_WEEK_PT.indexOf(a.dia);
                        const dayOrderB = DAYS_OF_WEEK_PT.indexOf(b.dia);
                        
                        if (dayOrderA !== dayOrderB) {
                            return dayOrderA - dayOrderB;
                        }
                        return a.horario.localeCompare(b.horario);
                    });
                    
                    // 3. Formatar e unir com <br>
                    classesDisplay = detailedClasses.map(aula => {
                        const professorDisplay = aula.professor ? ` (${aula.professor})` : '';
                        return `${aula.dia} - ${aula.horario} | ${aula.modalidade}${professorDisplay}`;
                    }).join('<br>'); // Junta com quebra de linha (lista)
                }
                // --- FIM Lﾃｳgica de Modalidades ---

                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-indigo-600">${profile.name} <span class="text-gray-500 text-xs">(${profile.id})</span></td>
                        <td class="px-6 py-4 text-sm text-gray-900">${profile.phone || 'N/A'}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${status.display} (${statusText})
                            </span>
                        </td>
                        
                        <td class="px-6 py-4 text-sm text-gray-900" title="Lista completa de modalidades matriculadas.">
                            ${classesDisplay}
                        </td>
                        
                        <td class="px-6 py-4 text-sm font-medium space-x-2">
                            <button onclick="editStudent('${profile.id}')" class="px-3 py-1 text-sm bg-indigo-500 text-white rounded hover:bg-indigo-600">Editar</button>
                            <button onclick="showAdminQrCodeForStudent('${profile.id}')" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">QR Code</button>
                            <button onclick="deleteStudent('${profile.id}')" class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600">Excluir</button>
                        </td>
                    </tr>
                `;
            });
            
            // 3. Fecha as tags da tabela e injeta o HTML completo
            tableHTML += `</tbody></table></div>`;
            
            container.innerHTML = tableHTML;
        }

        async function editStudent(studentId) {
            const profile = await getProfile(studentId);

            if (!profile) {
                showMessageBox('Erro', 'Perfil do aluno nﾃ｣o encontrado. (ID: ' + studentId + ')', 'error');
                return;
            }

            // --- POPULANDO CAMPOS: Adicionando checagens de seguranﾃｧa (Resolvendo 'Cannot set properties of null') ---
            
            // Tﾃｭtulo do Modal
            const modalTitleEl = document.getElementById('edit-modal-title');
            if (modalTitleEl) modalTitleEl.textContent = 'Editar Aluno';

            // Campos do Formulﾃ｡rio
            const idHolderEl = document.getElementById('edit-id-holder');
            if (idHolderEl) idHolderEl.value = profile.id;
            
            const nameEl = document.getElementById('edit-name');
            if (nameEl) nameEl.value = profile.name;
            
            const phoneEl = document.getElementById('edit-phone');
            if (phoneEl) phoneEl.value = profile.phone || '';
            
            const expiryDateEl = document.getElementById('edit-expiry-date');
            if (expiryDateEl) expiryDateEl.value = profile.expiryDate;

            // --- Lﾃ敵ICA ROBUSTA DE PRﾃ-SELEﾃﾃグ DAS CLASSES ---
            const classesSelect = document.getElementById('edit-enrollment');
            
            // Sﾃｳ executa a lﾃｳgica de seleﾃｧﾃ｣o se o elemento principal existir
            if (classesSelect) {
                // 1. Limpa todas as seleﾃｧﾃｵes anteriores
                Array.from(classesSelect.options).forEach(option => {
                    option.selected = false;
                });
                
                // 2. Extrai a lista de classes do perfil (retrocompatﾃｭvel)
                const rawClasses = profile.classes || profile.enrollment || [];
                
                // 3. Mapeia a lista para extrair APENAS o ID
                const studentClassIds = rawClasses
                    .map(c => {
                        if (typeof c === 'object' && c !== null && c.id) {
                            return String(c.id);
                        }
                        return String(c);
                    })
                    .filter(id => id);

                // 4. Percorre as opﾃｧﾃｵes do select e marca as que correspondem aos IDs
                if (studentClassIds.length > 0) {
                    Array.from(classesSelect.options).forEach(option => {
                        if (studentClassIds.includes(option.value)) {
                            option.selected = true;
                        }
                    });
                }
            } else {
                 console.error("Elemento 'edit-enrollment' (Select de Modalidades) nﾃ｣o encontrado.");
            }
            // --- FIM DA Lﾃ敵ICA DE PRﾃ-SELEﾃﾃグ ---

            // Exibe o modal (ﾃ嗟timo passo que deve ocorrer se tudo deu certo)
            const formContainerEl = document.getElementById('edit-student-form-container');
            if (formContainerEl) {
                formContainerEl.classList.remove('hidden');
            } else {
                showMessageBox('Erro Crﾃｭtico', 'O container do formulﾃ｡rio de ediﾃｧﾃ｣o estﾃ｡ faltando no HTML.', 'error');
            }
        }
        
        async function saveStudentFromAdmin() {
            const id = document.getElementById('edit-id-holder').value || getUniqueUserId();
            const name = document.getElementById('edit-name').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();
            const expiryDate = document.getElementById('edit-expiry-date').value.trim();
            
            // O ID do SELECT deve ser 'edit-enrollment' (conforme seu cﾃｳdigo)
            const enrollmentSelect = document.getElementById('edit-enrollment');
            
            // --- CORREﾃﾃグ APLICADA AQUI ---
            // 1. Mapeia as opﾃｧﾃｵes selecionadas para objetos {name, id}
            const selectedClasses = Array.from(enrollmentSelect.selectedOptions).map(option => ({
                name: option.text, // Pega o texto visﾃｭvel (nome da modalidade)
                id: option.value   // Pega o valor (ID/cﾃｳdigo da modalidade)
            }));
            // --- FIM DA CORREﾃﾃグ ---
            
            // Validaﾃｧﾃ｣o agora usa 'selectedClasses'
            if (!name || !phone || !expiryDate || selectedClasses.length === 0) {
                showMessageBox('Erro de Cadastro', 'Por favor, preencha todos os campos e selecione pelo menos uma aula.', 'warning');
                return;
            }

            const profileToSave = {
                id,
                name,
                phone,
                expiryDate,
                // *** CORREﾃﾃグ CRﾃ控ICA AQUI ***
                // Padronizando o campo para 'enrollment', que ﾃｩ o nome esperado pelo sistema de check-in.
                enrollment: selectedClasses 
            };

            try {
                await saveProfileToDB(profileToSave);
                showMessageBox('Sucesso', `Aluno(a) ${name} salvo(a) com sucesso!`, 'success');
                document.getElementById('edit-student-form-container').classList.add('hidden');
                
                // Recarrega e renderiza a tabela para mostrar o novo dado
                await getAllProfiles();
                renderStudentManagementTable();
            } catch (e) {
                // *** ADICIONE ISTO PARA VER O ERRO REAL ***
                console.error("Erro detalhado ao salvar perfil:", e); 
                // ***************************************
                showMessageBox('Erro', 'Falha ao salvar o perfil.', 'error');
            }
        }

        async function deleteStudent(id) {
            if (!confirm('Tem certeza que deseja EXCLUIR este aluno? Isso nﾃ｣o pode ser desfeito.')) return;

            try {
                await deleteProfile(id);
                showMessageBox('Sucesso', 'Aluno excluﾃｭdo.', 'success');
                await getAllProfiles();
                renderStudentManagementTable();
            } catch (e) {
                showMessageBox('Erro', 'Falha ao excluir aluno.', 'error');
            }
        }

        function showAdminQrCodeForStudent(id) {
            const profile = ALL_STUDENTS_PROFILES.find(p => p.id === id);
            if (!profile) {
                showMessageBox('Erro', 'Perfil do aluno nﾃ｣o encontrado.', 'error');
                return;
            }

            const qrcodeContainer = document.getElementById('qrcodeDisplay');
            qrcodeContainer.innerHTML = '';
            
            new QRCode(qrcodeContainer, {
                text: profile.id, 
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            document.getElementById('qrCodeModal').classList.remove('hidden');
        }

        // --- Funﾃｧﾃｵes de Login/Inicializaﾃｧﾃ｣o (CORRIGIDO PARA USAR ASYNC/AWAIT) ---

        async function handleAdminLogin() { // CORRIGIDO: AGORA ﾃ ASYNC
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('isAdmin', 'true');
                showView('admin-view');
                document.getElementById('adminPassword').value = '';
                await initAdminViewData(); // CORRIGIDO: Adicionado 'await'
            } else {
                showMessageBox('Erro de Acesso', 'Senha de administrador incorreta.', 'error');
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        function handleAdminLogout() {
            localStorage.removeItem('isAdmin');
            // Limpa o intervalo de refresh ao sair.
            if (classRefreshInterval) {
                clearInterval(classRefreshInterval);
                classRefreshInterval = null;
            }
            showView('login-view');
            allProfiles = [];
            allCheckins = [];
            document.getElementById('adminPassword').value = '';
        }

        async function initAdminViewData() {
            // *** NOVO: Executa a migraﾃｧﾃ｣o antes de carregar os dados ***
            await migrateLocalProfilesToCloud(); 
            // Garante que todos os dados necessﾃ｡rios para o admin estejam carregados.
            await getAllProfiles(); // Carrega todos os perfis para a gestﾃ｣o
            await getCheckins(); // Carrega todos os check-ins para a checagem de duplicidade e ocupaﾃｧﾃ｣o
            
            await showAdminSubView('admin-quick-checkin-view'); // AGORA COM AWAIT
        }

        function wireUpEvents() {
            // Eventos do Menu
            document.getElementById('btn-admin-quick-checkin')?.addEventListener('click', async () => await showAdminSubView('admin-quick-checkin-view'));
            document.getElementById('btn-admin-manage')?.addEventListener('click', async () => await showAdminSubView('admin-manage-students-view'));
            document.getElementById('btn-admin-manage-schedule')?.addEventListener('click', async () => await showAdminSubView('admin-manage-schedule-view'));
            document.getElementById('btn-admin-checkin-history')?.addEventListener('click', async () => await showAdminSubView('admin-history-view'));
            document.getElementById('btn-admin-logout')?.addEventListener('click', handleAdminLogout);

            // Eventos do Scanner
            document.getElementById('btn-open-admin-scanner')?.addEventListener('click', openAdminScannerModal);
            document.getElementById('closeAdminScannerBtn')?.addEventListener('click', closeAdminScannerModal);

            // Eventos Quick Check-in
            document.getElementById('btn-process-checkin')?.addEventListener('click', async () => {
                const studentId = document.getElementById('quickCheckinStudentId').value.trim();
                await processAutomaticCheckin(studentId);
            });

            // Eventos Gerenciamento de Alunos
            document.getElementById('btn-add-new-student-admin')?.addEventListener('click', () => {
                document.getElementById('edit-id-holder').value = '';
                document.getElementById('edit-form-title').textContent = 'Cadastrar Novo Aluno';
                document.getElementById('edit-name').value = '';
                document.getElementById('edit-phone').value = '';
                document.getElementById('edit-expiry-date').value = '';
                Array.from(document.getElementById('edit-enrollment').options).forEach(option => option.selected = false); 
                document.getElementById('edit-student-form-container').classList.remove('hidden');
            });
            document.getElementById('btn-save-student')?.addEventListener('click', saveStudentFromAdmin);
            document.getElementById('btn-cancel-edit')?.addEventListener('click', () => {
                document.getElementById('edit-student-form-container').classList.add('hidden');
            });

            // Eventos Gerenciamento de Grade
            document.getElementById('btn-add-new-class-admin')?.addEventListener('click', () => {
                document.getElementById('edit-class-id-holder').value = '';
                document.getElementById('edit-class-form-title').textContent = 'Cadastrar Nova Aula';
                document.getElementById('edit-class-modalidade').value = '';
                document.getElementById('edit-class-dia').value = '';
                document.getElementById('edit-class-horario').value = '';
                document.getElementById('edit-class-professor').value = '';
                document.getElementById('edit-class-capacidade').value = '1';
                document.getElementById('edit-class-token').value = '';
                document.getElementById('edit-class-form-container').classList.remove('hidden');
            });
            document.getElementById('btn-save-class')?.addEventListener('click', saveClassFromAdmin);
            document.getElementById('btn-cancel-class-edit')?.addEventListener('click', () => {
                document.getElementById('edit-class-form-container').classList.add('hidden');
            });

            // Eventos Histﾃｳrico
            document.getElementById('applyFiltersBtn')?.addEventListener('click', renderCheckinHistory);
            document.getElementById('clearHistoryBtn')?.addEventListener('click', async () => {
                 if (!confirm('ATENﾃﾃグ: Vocﾃｪ estﾃ｡ prestes a limpar TODO o histﾃｳrico de check-ins. Esta aﾃｧﾃ｣o nﾃ｣o pode ser desfeita.')) return;
                 try {
                     await clearAllCheckins();
                     showMessageBox('Sucesso', 'Histﾃｳrico de check-in limpo permanentemente.', 'success');
                     renderCheckinHistory();
                 } catch (e) {
                     showMessageBox('Erro', 'Falha ao limpar histﾃｳrico.', 'error');
                 }
            });

            // Eventos Modal de Grade
            document.getElementById('closeGradeModalBtn')?.addEventListener('click', () => {
                document.getElementById('gradeModal').classList.add('hidden');
            });

        }

        async function init() {
            initFirebase(); // <-- NOVO: Inicializa o Firebase
            await openDB();
            await loadScheduleFromDB(); 
            populateRegistrationOptions();

            const isAdmin = localStorage.getItem('isAdmin') === 'true';

            if (isAdmin) {
                await initAdminViewData(); 
                showView('admin-view');
            } else {
                showView('login-view');
            }

            wireUpEvents();
        }

        // Torna funﾃｧﾃｵes globais
        window.applyFilters = renderCheckinHistory;
        window.clearAllFilters = clearAllFilters;
        window.editStudent = editStudent;
        window.deleteStudent = deleteStudent;
        window.showAdminQrCodeForStudent = showAdminQrCodeForStudent;
        window.editClass = editClass;
        window.deleteClass = deleteClass;
        window.handleAdminLogin = handleAdminLogin; // AGORA ﾃ ASYNC
        
        window.closeMessageBox = closeMessageBox;


        // Inicia a aplicaﾃｧﾃ｣o
        window.onload = init;
    </script>
</body>
</html>